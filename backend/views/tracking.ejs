<div class="video-background">
  <video autoplay loop muted playsinline>
    <source src="/images/tracking.mp4" type="video/mp4">
  </video>
</div>

<section class="section fade-in">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <h2 class="section-title text-center mb-4">Order Tracking</h2>

        <% 
          const normalizedStatus = orderStatus === 'pending' ? 'confirmed' : orderStatus;
          const steps = [
            { key: 'confirmed', label: 'Order Confirmed', icon: 'fa-check-circle' },
            { key: 'preparing', label: 'Preparing Your Meal', icon: 'fa-utensils' },
            { key: 'delivery', label: 'Out for Delivery', icon: 'fa-truck' },
            { key: 'delivered', label: 'Delivered', icon: 'fa-check-double' }
          ];
          let currentIndex = steps.findIndex(s => s.key === normalizedStatus);
          if (currentIndex === -1) currentIndex = 0;
        %>

        <div class="tracking-card mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-1">Order #<%= orderId %></h5>
              <p class="text-muted mb-0">
                <i class="fa-regular fa-clock"></i> 
                Placed on <%= new Date(orderDate).toLocaleString() %>
              </p>
            </div>
            <div class="text-end">
              <h5 class="text-primary mb-0">$<%= parseFloat(orderTotal).toFixed(2) %></h5>
              <small class="text-muted">Total Amount</small>
            </div>
          </div>
        </div>

        <div class="tracking-card" id="tracking-container" data-order-id="<%= orderId %>">
          <h5 class="mb-4">Order Status</h5>
          <div class="timeline" id="status-timeline">
            <% steps.forEach((step, index) => { %>
              <div class="timeline-item" data-step-key="<%= step.key %>">
                <div class="timeline-dot 
                  <%= index < currentIndex ? 'completed' : '' %> 
                  <%= index === currentIndex ? 'active' : '' %>">
                  <i class="fa-solid <%= step.icon %>"></i>
                </div>
                <div class="timeline-content">
                  <p class="timeline-label <%= index === currentIndex ? 'active-label' : '' %>">
                    <%= step.label %>
                  </p>
                </div>
              </div>
            <% }) %>
          </div>
          
          <div class="text-center mt-3">
             <small class="text-muted">
                <i class="fa-solid fa-circle-notch fa-spin"></i> 
                <span id="last-update">Syncing status...</span>
             </small>
          </div>
        </div>

        <div class="text-center mt-4">
          <a href="/" class="btn btn-outline-primary me-2">
            <i class="fa-solid fa-home"></i> Back to Home
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function() {
    const orderId = document.getElementById('tracking-container').getAttribute('data-order-id');
    const stepKeys = ['confirmed', 'preparing', 'delivery', 'delivered'];
    const timelineItems = document.querySelectorAll('.timeline-item');

    function updateUI(status) {
        // Normalize status
        const currentStatus = status === 'pending' ? 'confirmed' : status;
        const currentIndex = stepKeys.indexOf(currentStatus);

        timelineItems.forEach((item, i) => {
            const dot = item.querySelector('.timeline-dot');
            const label = item.querySelector('.timeline-label');
            
            // Remove all states first
            dot.classList.remove('completed', 'active');
            label.classList.remove('active-label');

            if (i < currentIndex) {
                dot.classList.add('completed');
            } else if (i === currentIndex) {
                dot.classList.add('active');
                label.classList.add('active-label');
            }
        });

        document.getElementById('last-update').textContent = 'Last checked: ' + new Date().toLocaleTimeString();
        
        // Stop refresh if delivered
        if (currentStatus === 'delivered') {
            clearInterval(refreshInterval);
            document.querySelector('.fa-circle-notch').style.display = 'none';
            document.getElementById('last-update').textContent = 'Order Delivered!';
        }
    }

    async function fetchStatus() {
        try {
            const res = await fetch('/api/tracking/' + orderId);
            const data = await res.json();
            updateUI(data.status);
        } catch (err) {
            console.error("Tracking fetch failed", err);
        }
    }

    // Auto refresh every 5 seconds
    const refreshInterval = setInterval(fetchStatus, 5000);

    // Initial check
    fetchStatus();
})();
</script>